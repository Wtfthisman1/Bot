services:
  bot:
    build: 
      context: .
      dockerfile: Dockerfile
      target: runtime
    container_name: telegram-bot
    ports:
      - "8080:8080"
    environment:
      # Обязательные переменные
      - BOT_TOKEN=${BOT_TOKEN}
      - ADMIN_CHAT_ID=${ADMIN_CHAT_ID}
      
      # Предзагрузка моделей Whisper
      - WHISPER_PRELOAD_MODELS=medium
      - WHISPER_DEVICE=cpu
      - WHISPER_COMPUTE_TYPE=int8
      
      # Настройки JVM
      - JAVA_OPTS=-Xmx2g -Xms512m -XX:+UseG1GC -XX:+UseContainerSupport
      
      # Настройки приложения
      - UPLOAD_DIR=/app/upload
      - APP_STORAGE_BASE=/app/upload/videos
      - XDG_CACHE_HOME=/app/.cache
      - HF_HOME=/app/.cache/huggingface
      # Пути к Python скриптам для Docker
      - WHISPER_SCRIPT=/app/pythonScript/Transcribe.py
      - DOWNLOADER_SCRIPT=/app/pythonScript/Downloader.py
    volumes:
      # Пользовательские файлы
      - ./upload:/app/upload
      # Логи приложения
      - ./logs:/app/logs
      # Кеш моделей Whisper (сохраняется между пересборками!)
      - whisper_cache:/app/.cache
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - bot-network

volumes:
  # Именованный том для кеша моделей
  whisper_cache:
    driver: local

networks:
  bot-network:
    driver: bridge
